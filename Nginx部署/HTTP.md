# HTTP

http,Redis,MongoDB.Mysql,Kafka,消息队列,epoll,poll,select, Nginx

HTTP的请求头分为四种:通用标头,请求标头,响应标头和实体标头.

### 通用标头

通用标头主要有三个,分别是Date,Cache-Control和Connection

### Date

Date是一个通用标头

### Cache-Control

Cache-Control是一个通用标头,它可以出现在请求标头和响应标头中.

### HTTP的优点和缺点

##### 优点

###### 简单灵活扩展

HTTP的协议比较简单,它的主要组成就是header + body,头部信息也是简单的文本格式,而且HTTP的请求报文根据英文也能猜出来个大概的意思,降低了学习门槛,能够让更多的人研究和开发HTTP应用.

所以,在简单的基础上,HTTP协议又多了灵活和易扩展的优点.

HTTP协议里的请求方法,URI,状态码,原因短语,头字段等每一个核心组成要素都没有被制定死,允许开发者任意定制,扩充或解释,给予了浏览器和服务器最大程度的信任和自由.

###### 应用广泛、环境成熟

因为过于简单，普及，因此应用很广泛。因为HTTP协议本身不属于一种语言,它并不限定某种编程语言或者操作系统,所以天然具有跨语言,跨平台的优越性.

### I/O多路复用模型

I/O复用指的是多个I/O连接复用一个进程.最初级的I/O复用,就是一个进程对应多个连接,每次从头至尾进行遍历,判断是否有I/O事件需要处理,有的话就进行处理,缺点是效率比较低,如果一直没有事件进来,会导致CPU空转.升级版的I/O复用模型.当没有I/O事件时,进程处于阻塞状态,当有I/O事件时,就会有一个代理去唤醒进程,去进行轮询,来处理I/O事件.(这里的代理也就是select和poll,select只能观察1024个连接,poll可以观察无线个连接)。epoll是对select和poll的升级版,解决了很多问题,是线程安全的,而且可以通知进程是哪个socket连接有I/O事件,提高了查找效率,epoll和select/poll最大的区别是:

- epoll内部使用了mmap共享了用户和内核的部分空间,避免了数据的来回拷贝
- epoll基于事件驱动,epoll_wait只返回发生的事件避免了像select和poll对事件的整个轮询操作.

### 信息驱动式I/O模型

是非阻塞的,当需要等待数据时,用户态进程会给内核发送一个信号,告知自己需要的数据,然后就去执行其他任务了,内核准备好数据后,会给用户态发送一个信号,用户态进程收到之后,会立马调用recvfrom,等待数据从内核空间复制到用户空间,待完成之后recvfrom返回成功指示,用户态进程才能处理数据.

### 异步I/O模型

与信息驱动式I/O模型区别在于,是在数据从内核态拷贝到用户空间之后,内核才通知用户态进程来处理数据.在复制数据到用户空间的这个时间段内,用户态进程也是不阻塞的.

### 同步与异步的区别是什么?

同步与异步的区别在于调用结果的通知方式上,同步执行一个方法后,需要等待结果返回,然后继续执行下去,异步执行一个方法后,不会等待结果的返回,调用方定时主动去轮询调用结果被调用方在执行完成后通过回调来通知调用方.

### 阻塞与非阻塞的区别是什么?

阻塞与非阻塞的区别在于进程/线程在等待消息时,进程/线程是否是挂起状态.

### 阻塞调用

在消息发出去后,消息返回之前,当前进程/线程会被挂起,直到有消息返回,当前进/线程才会被激活.

### 非阻塞调用

在消息发出去之后,不会阻塞当前进/线程,而会立即返回,可以去执行其他任务。

### 如何解决Redis缓存穿透问题?

Redis缓存穿透指的是攻击者大量请求一些Redis缓存中不存在key的数据,导致请求达到数据库上,导致数据库压力过大。

### 解决方案如下：

1. 在给缓存设置失效时间时加一个随机值,避免集体失效。
2. 双缓存机制，缓存A的失效时间为20分钟,缓存B没有失效时间,从缓存A读取数据,缓存A中没有时,去缓存B中读取数据,并且启动一个异步线程来更新缓存A。

### 哈希表扩展和收缩的触发条件

扩展操作：

1、服务器目前没有在执行bgsave命令或者bgrewariteaof命令,并且哈希表的负载因子大于等于1。

2、服务器目前正在执行bsave命令或者bgrewrite命令。

### Redis哨兵系统是怎么实现自动故障转移的？

1、认定主节点主观下线

因为每隔2s,哨兵节点会给主节点发送ping命令,如果在一定时间间隔内,都没有收到回复,那么哨兵结点就认为主节点主观下线。

2、认定主节点客观下线

哨兵结点认定主节点主观下下线后，会像其他哨兵结点发送sentinel is-master-down-by-addr命令,获取其他哨兵结点对该主结点的状态,当认定主节点下线的哨兵数量达到一定数值时,就认定主节点客观下线。

3、进行领导者哨兵选举

认定主节点客观下线后，各个哨兵之间相互通信，选举出一个领导者哨兵，由它来对主节点进行故障转移操作。

选举使用的是Raft算法,基本思路是所有哨兵结点A会先其他哨兵结点,发送命令,申请成为该哨兵结点B的领导者,如果B还没有同意过其他哨兵结点,那么就同意A成为领导者,最终得票超过半数以上的哨兵结点会赢得选举,如果本次投票,没有选举出领导者哨兵,那么就开始新一轮的选举,直到选择出哨兵结点(实际开发中,最先判定主节点客观下线的哨兵结点,一般就能成为领导者。

4、领导者哨兵进行故障转移

领导者哨兵结点首先会从结点中选出一个结点作为新的主节点，选择的原则是：

- 首先排除一些不健康的结点。（下线的，断线的，最近5s没有回复哨兵结点的INFO命令的,与旧的主服务器断开连接时间较长的)
- 然后根据优先级,复制偏移量,runid最小,来选出一个从结点作为主节点。

向这个从结点发送slaveof no one命令,让其成为主节点,通过salveof命令让其他从结点成为它的从结点,将已下线的主节点更新为新的主节点的从结点.

5、组织没由领域专家

对问题域有深刻见解的主题专家称为领域专家,在大多数组织中没有这个角色,当DDD建模需要领域专家支持时,组织往往找业务部门的业务人员,BA,产品经理或在这个领域有多年开发经验的DEV来充当.

这些一线业务人员和开发团队都清楚有什么功能,但往往不清楚为什么有这些功能.举个例子:如果我们的问题是打开一瓶红酒,你去调研每天都会打开酒瓶的waiter,给你的答案是:开瓶器.但换做领域专家的视角来看,会回归问题的本质,如果我们希望打开酒瓶,需要把瓶塞移除,移除瓶塞的方式,包括推,撬与拉拽,对于拉拽可能基于吸力或螺旋拉拽.在辅导团队的过程中,为了弥补这部分视角的缺失,往往会在事件风暴之前,组织业务愿景和场景分析,与被指派的业务干系人对齐业务愿景,一起分析业务场景背后的问题域,找到问题域的本质后再展开事件风暴.

6、面向复杂业务系统的事件风暴

高效事件风暴的规模推荐5-8人,超过8人的事件风暴就会出现讨论时间过长,部分成员参与度不高,业务之间的相关度弱等问题.在一个以支付中台为主题的事件风暴中,对于电商商城的支付与理财产品的支付相关性就很弱,各自关心的是自己的业务.让这两组人在一起讨论,在得到同样产出的情况下,会花费双倍的时间。

在处理复杂问题时,一个有效又好用的方法是分而治之,对于复杂系统的事件风暴也是同样如此.在业务干系人达到一定规模后,将业务干系人分成多组,组织多轮事件风暴,迭代演进领域模型也是一种不错的选择。

分组的基本原则应以业务线为线索，如果按照目标系统的业务干系人在同一个业务主线上，每一组人代表业务主线上的一个环节，这种情况按照业务结点进行分组即可。对于业务相对简单的结点，可以将其与相临结点合并组织事件风暴。

当目标系统是多条业务线上的某几个公共结点，一般业务中台会出现这种情况，如支付中台要为不同的业务部门（保险，商城，还信用卡等）提供支付业务。这类业务往往结点之间的边界并没有那么清楚，系统做什么与不做什么只有在梳理完整条业务线才能确认下来，这种情况按每条业务线分组展开事件风暴，然后针对多组产出结果进行统一业务概念抽象，建立系统边界内的统一事件流。

7、业务代表或领域专家用自己的语言表达业务

事件风暴的第一个环节是让参与者头脑风暴，各自找出业务干系人关注的领域事件，对于业务干系人来讲，往往不适应把自己理解的业务按领域事件的方式表达出来，他们看到一串领域事件，也不觉得这种表达方式比传统方式直观，在这种情况下，我们就需要考虑如何引导业务共同输出领域事件。留心领域专家在表达需求过程中的一些模式：

- 当...
- 如果发生...
- 当...的时候请通知我
- 发生...时

通过模式中的关键字转换成领域事件,按时间顺序排序后,基于商业模式与价值定位与领域专家讨论领域事件,以统一的语言与统一的业务视角修正并验证领域事件.高质量的领域事件定义自然是清楚的,是可以找到问题域中的某个actor是关注它的,通过讲述领域事件是可以体现商业价值的。

8、事件风暴可能识别不出来所有领域事件

通过事件风暴可以快速把整个问题域主线梳理出来，这样的产出是相当的高效和有价值，但对于正在尝试用事件风暴成果代替传统交付物的组织，往往会质疑事件风暴是否可以发现所有领域事件。

试考虑一个投资者，为一座摩天大楼的建造提供资金，投资者未必对建造过程的细节感兴趣，材料的选择及各种工程细节会议对于建造者来说是很重要的活动。对于投资者来讲，感兴趣的是良好的投资回报，保护投资免受风险，较为务实的投资者会设立明确的里程碑，每个里程碑通过后再做下一次注资。例如，在项目开始时，提供适量资金进行建筑设计工作。当建造事宜被批准时，再为项目提供较多的资金以进行设计工作。在设计通过评审过后，才拨给更大量的资金，以便建造者破土动工。梳理得到事件如下：

系统建模同理,我们不关注所有事件,仅关注对干系人解决特定问题有价值的事件,并且这个特定问题应该已经在项目初期,业务愿景梳理的过程中在组织内达成了共识,就像上述投资者关注的问题一样清楚,在业务场景梳理与事件风暴的过程中,不断还原具体过程,以确保识别出的活动或事件真正可以解决业务问题,所以在事件风暴的过程中,并不需要担心是不是找出所有领域事件,只要真正解决了业务问题就好了。

另外，当开始采用新的方法论时，事件过程与角度都有差别，旧有体系的交付物不适用是常有的情况，重点关注的新的方法会不会以更简洁的方式解决实际问题。在存疑的风险处，活学活用新方法的交付物能够让组织更顺利的落地，当然必要的开发过程与交付物改进也是需要的，即可以更高效的完成设计工作，也能让团队更专注在问题上。

### 总结

有人说微服务的设计与拆分是一门艺术，经验性的成份占了很大比重。当我们准备基于经验来做微服务的设计决策时，结合业务愿景，找出问题域内所有业务干系人真正关心的领域事件，展开完整的事件风暴，循序渐进的让场景变得更加具体，让经验与艺术在生动的问题域之中得到最大的发挥。

另一方面，有效地识别领域事件，既统一了语言，又助力在模型中体现出业务的价值部分，为设计关注业务价值的领域模型打下了坚实的基础。

















